<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>15 Outcome regression and propensity scores | R Code for Causal Inference: What If</title>
  <meta name="description" content="15 Outcome regression and propensity scores | R Code for Causal Inference: What If." />
  <meta name="generator" content="bookdown 0.28 and GitBook 2.6.7" />

  <meta property="og:title" content="15 Outcome regression and propensity scores | R Code for Causal Inference: What If" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="15 Outcome regression and propensity scores | R Code for Causal Inference: What If." />
  <meta name="github-repo" content="behrman/ci-wi" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="15 Outcome regression and propensity scores | R Code for Causal Inference: What If" />
  
  <meta name="twitter:description" content="15 Outcome regression and propensity scores | R Code for Causal Inference: What If." />
  

<meta name="author" content="Bill Behrman" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="14.html"/>
<link rel="next" href="16.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">R Code for Causal Inference: What If</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-install-required-r-packages"><i class="fa fa-check"></i>How to install required R packages</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-download-dataset"><i class="fa fa-check"></i>How to download dataset</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#source-for-this-book"><i class="fa fa-check"></i>Source for this book</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="11.html"><a href="11.html"><i class="fa fa-check"></i>11 Why Model?</a>
<ul>
<li class="chapter" data-level="" data-path="11.html"><a href="11.html#data-cannot-speak-for-themselves"><i class="fa fa-check"></i>11.1 Data cannot speak for themselves</a></li>
<li class="chapter" data-level="" data-path="11.html"><a href="11.html#parametric-estimators-of-the-conditional-mean"><i class="fa fa-check"></i>11.2 Parametric estimators of the conditional mean</a></li>
<li class="chapter" data-level="" data-path="11.html"><a href="11.html#nonparametric-estimators-of-the-conditional-mean"><i class="fa fa-check"></i>11.3 Nonparametric estimators of the conditional mean</a></li>
<li class="chapter" data-level="" data-path="11.html"><a href="11.html#smoothing"><i class="fa fa-check"></i>11.4 Smoothing</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="12.html"><a href="12.html"><i class="fa fa-check"></i>12 IP weighting and marginal structural models</a>
<ul>
<li class="chapter" data-level="" data-path="12.html"><a href="12.html#the-causal-question"><i class="fa fa-check"></i>12.1 The causal question</a></li>
<li class="chapter" data-level="" data-path="12.html"><a href="12.html#estimating-ip-weights-via-modeling"><i class="fa fa-check"></i>12.2 Estimating IP weights via modeling</a></li>
<li class="chapter" data-level="" data-path="12.html"><a href="12.html#stabilized-ip-weights"><i class="fa fa-check"></i>12.3 Stabilized IP weights</a>
<ul>
<li class="chapter" data-level="" data-path="12.html"><a href="12.html#fine-point-12.2-checking-positivity"><i class="fa fa-check"></i>Fine Point 12.2 Checking positivity</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="12.html"><a href="12.html#marginal-structural-models"><i class="fa fa-check"></i>12.4 Marginal structural models</a></li>
<li class="chapter" data-level="" data-path="12.html"><a href="12.html#effect-modification-and-marginal-structural-models"><i class="fa fa-check"></i>12.5 Effect modification and marginal structural models</a></li>
<li class="chapter" data-level="" data-path="12.html"><a href="12.html#censoring-and-missing-data"><i class="fa fa-check"></i>12.6 Censoring and missing data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="13.html"><a href="13.html"><i class="fa fa-check"></i>13 Standardization and the parametric g-formula</a>
<ul>
<li class="chapter" data-level="" data-path="13.html"><a href="13.html#standardization-as-an-alternative-to-ip-weighting"><i class="fa fa-check"></i>13.1 Standardization as an alternative to IP weighting</a></li>
<li class="chapter" data-level="" data-path="13.html"><a href="13.html#estimating-the-mean-outcome-via-modeling"><i class="fa fa-check"></i>13.2 Estimating the mean outcome via modeling</a></li>
<li class="chapter" data-level="" data-path="13.html"><a href="13.html#standardizing-the-mean-outcome-to-the-confounder-distribution"><i class="fa fa-check"></i>13.3 Standardizing the mean outcome to the confounder distribution</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="14.html"><a href="14.html"><i class="fa fa-check"></i>14 G-estimation and structural nested models</a>
<ul>
<li class="chapter" data-level="" data-path="14.html"><a href="14.html#the-causal-question-revisited"><i class="fa fa-check"></i>14.1 The causal question revisited</a></li>
<li class="chapter" data-level="" data-path="14.html"><a href="14.html#rank-preservation"><i class="fa fa-check"></i>14.4 Rank preservation</a></li>
<li class="chapter" data-level="" data-path="14.html"><a href="14.html#g-estimation"><i class="fa fa-check"></i>14.5 G-estimation</a></li>
<li class="chapter" data-level="" data-path="14.html"><a href="14.html#structural-nested-models-with-two-or-more-parameters"><i class="fa fa-check"></i>14.6 Structural nested models with two or more parameters</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="15.html"><a href="15.html"><i class="fa fa-check"></i>15 Outcome regression and propensity scores</a>
<ul>
<li class="chapter" data-level="" data-path="15.html"><a href="15.html#outcome-regression"><i class="fa fa-check"></i>15.1 Outcome regression</a></li>
<li class="chapter" data-level="" data-path="15.html"><a href="15.html#propensity-scores"><i class="fa fa-check"></i>15.2 Propensity scores</a></li>
<li class="chapter" data-level="" data-path="15.html"><a href="15.html#propensity-stratification-and-standardization"><i class="fa fa-check"></i>15.3 Propensity stratification and standardization</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="16.html"><a href="16.html"><i class="fa fa-check"></i>16 Instrumental variable estimation</a>
<ul>
<li class="chapter" data-level="" data-path="16.html"><a href="16.html#the-three-instrumental-conditions"><i class="fa fa-check"></i>16.1 The three instrumental conditions</a></li>
<li class="chapter" data-level="" data-path="16.html"><a href="16.html#the-usual-iv-estimand"><i class="fa fa-check"></i>16.2 The usual IV estimand</a></li>
<li class="chapter" data-level="" data-path="16.html"><a href="16.html#the-three-instrumental-conditions-revisited"><i class="fa fa-check"></i>16.5 The three instrumental conditions revisited</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="17.html"><a href="17.html"><i class="fa fa-check"></i>17 Causal survival analysis</a>
<ul>
<li class="chapter" data-level="" data-path="17.html"><a href="17.html#hazards-and-risks"><i class="fa fa-check"></i>17.1 Hazards and risks</a></li>
<li class="chapter" data-level="" data-path="17.html"><a href="17.html#from-hazards-to-risks"><i class="fa fa-check"></i>17.2 From hazards to risks</a></li>
<li class="chapter" data-level="" data-path="17.html"><a href="17.html#ip-weighting-of-marginal-structural-models"><i class="fa fa-check"></i>17.4 IP weighting of marginal structural models</a></li>
<li class="chapter" data-level="" data-path="17.html"><a href="17.html#the-parametric-g-formula"><i class="fa fa-check"></i>17.5 The parametric g-formula</a></li>
<li class="chapter" data-level="" data-path="17.html"><a href="17.html#g-estimation-of-structural-nested-models"><i class="fa fa-check"></i>17.6 G-estimation of structural nested models</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="results.html"><a href="results.html"><i class="fa fa-check"></i>Results</a>
<ul>
<li class="chapter" data-level="" data-path="results.html"><a href="results.html#average-treatment-effect"><i class="fa fa-check"></i>Average treatment effect</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Code for Causal Inference: What If</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="outcome-regression-and-propensity-scores" class="section level1 unnumbered hasAnchor">
<h1>15 Outcome regression and propensity scores<a href="15.html#outcome-regression-and-propensity-scores" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="15.html#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Packages</span></span>
<span id="cb129-2"><a href="15.html#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb129-3"><a href="15.html#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="15.html#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb129-5"><a href="15.html#cb129-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># NHEFS data</span></span>
<span id="cb129-6"><a href="15.html#cb129-6" aria-hidden="true" tabindex="-1"></a>file_nhefs <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">&quot;data/nhefs.rds&quot;</span>)</span>
<span id="cb129-7"><a href="15.html#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="15.html#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Round and format vector</span></span>
<span id="cb129-9"><a href="15.html#cb129-9" aria-hidden="true" tabindex="-1"></a>round_format <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">nsmall =</span> <span class="dv">2</span>, ...) {</span>
<span id="cb129-10"><a href="15.html#cb129-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format</span>(<span class="fu">round</span>(x, <span class="at">digits =</span> nsmall), <span class="at">nsmall =</span> nsmall, ...)</span>
<span id="cb129-11"><a href="15.html#cb129-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb129-12"><a href="15.html#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Print tibble</span></span>
<span id="cb129-13"><a href="15.html#cb129-13" aria-hidden="true" tabindex="-1"></a>kable <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">cols =</span> <span class="fu">where</span>(is.double), <span class="at">nsmall =</span> <span class="dv">2</span>, <span class="at">align =</span> <span class="st">&quot;r&quot;</span>, ...) {</span>
<span id="cb129-14"><a href="15.html#cb129-14" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span></span>
<span id="cb129-15"><a href="15.html#cb129-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>({{cols}}, round_format, <span class="at">nsmall =</span> nsmall)) <span class="sc">%&gt;%</span></span>
<span id="cb129-16"><a href="15.html#cb129-16" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">align =</span> align, ...) <span class="sc">%&gt;%</span> </span>
<span id="cb129-17"><a href="15.html#cb129-17" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, <span class="at">position =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb129-18"><a href="15.html#cb129-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb129-19"><a href="15.html#cb129-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-20"><a href="15.html#cb129-20" aria-hidden="true" tabindex="-1"></a><span class="co">#===============================================================================</span></span>
<span id="cb129-21"><a href="15.html#cb129-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-22"><a href="15.html#cb129-22" aria-hidden="true" tabindex="-1"></a><span class="co"># NHEFS data</span></span>
<span id="cb129-23"><a href="15.html#cb129-23" aria-hidden="true" tabindex="-1"></a>nhefs <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(file_nhefs)</span>
<span id="cb129-24"><a href="15.html#cb129-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-25"><a href="15.html#cb129-25" aria-hidden="true" tabindex="-1"></a><span class="co"># NHEFS censored for those with weight measurements in 1982</span></span>
<span id="cb129-26"><a href="15.html#cb129-26" aria-hidden="true" tabindex="-1"></a>nhefs_censored <span class="ot">&lt;-</span> </span>
<span id="cb129-27"><a href="15.html#cb129-27" aria-hidden="true" tabindex="-1"></a>  nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb129-28"><a href="15.html#cb129-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(wt82, wt82_71)</span></code></pre></div>
<div id="outcome-regression" class="section level2 unnumbered hasAnchor">
<h2>15.1 Outcome regression<a href="15.html#outcome-regression" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Fit linear regression using same model as in 13.2.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="15.html#cb130-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> </span>
<span id="cb130-2"><a href="15.html#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(</span>
<span id="cb130-3"><a href="15.html#cb130-3" aria-hidden="true" tabindex="-1"></a>    wt82_71 <span class="sc">~</span> qsmk <span class="sc">*</span> smokeintensity <span class="sc">+</span> sex <span class="sc">+</span> <span class="fu">poly</span>(age, <span class="dv">2</span>) <span class="sc">+</span> race <span class="sc">+</span> education <span class="sc">+</span></span>
<span id="cb130-4"><a href="15.html#cb130-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">poly</span>(wt71, <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">I</span>(smokeintensity<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">poly</span>(smokeyrs, <span class="dv">2</span>) <span class="sc">+</span> active <span class="sc">+</span></span>
<span id="cb130-5"><a href="15.html#cb130-5" aria-hidden="true" tabindex="-1"></a>      exercise,</span>
<span id="cb130-6"><a href="15.html#cb130-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> nhefs_censored</span>
<span id="cb130-7"><a href="15.html#cb130-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb130-8"><a href="15.html#cb130-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-9"><a href="15.html#cb130-9" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(fit)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 21 × 5
#&gt;    term           estimate std.error statistic       p.value
#&gt;    &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;
#&gt;  1 (Intercept)      1.67      0.903      1.85  0.0651       
#&gt;  2 qsmk1            2.56      0.809      3.16  0.00159      
#&gt;  3 smokeintensity   0.0491    0.0517     0.950 0.342        
#&gt;  4 sex1            -1.43      0.469     -3.05  0.00233      
#&gt;  5 poly(age, 2)1  -90.6      15.7       -5.76  0.00000000994
#&gt;  6 poly(age, 2)2  -36.2      10.2       -3.53  0.000421     
#&gt;  7 race1            0.560     0.582      0.963 0.336        
#&gt;  8 education2       0.790     0.607      1.30  0.193        
#&gt;  9 education3       0.556     0.556      1.00  0.317        
#&gt; 10 education4       1.49      0.832      1.79  0.0733       
#&gt; # … with 11 more rows
#&gt; # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>Estimates for coefficients of <code>qsmk1</code> and <code>qsmk1:smokeintensity</code>.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="15.html#cb132-1" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb132-2"><a href="15.html#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;qsmk1&quot;</span>, <span class="st">&quot;qsmk1:smokeintensity&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb132-3"><a href="15.html#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb132-4"><a href="15.html#cb132-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">nsmall =</span> <span class="dv">2</span>, <span class="at">align =</span> <span class="st">&quot;lr&quot;</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
qsmk1
</td>
<td style="text-align:right;">
2.56
</td>
</tr>
<tr>
<td style="text-align:left;">
qsmk1:smokeintensity
</td>
<td style="text-align:right;">
0.05
</td>
</tr>
</tbody>
</table>
<p>Use <code>multcomp::glht()</code> to estimate ATE with 95% confidence interval.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="15.html#cb133-1" aria-hidden="true" tabindex="-1"></a>ate <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, contrast) {</span>
<span id="cb133-2"><a href="15.html#cb133-2" aria-hidden="true" tabindex="-1"></a>  linfct <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> <span class="fu">length</span>(<span class="fu">coef</span>(fit)))</span>
<span id="cb133-3"><a href="15.html#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(linfct) <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">coef</span>(fit))</span>
<span id="cb133-4"><a href="15.html#cb133-4" aria-hidden="true" tabindex="-1"></a>  linfct[, <span class="fu">names</span>(contrast)] <span class="ot">&lt;-</span> contrast</span>
<span id="cb133-5"><a href="15.html#cb133-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-6"><a href="15.html#cb133-6" aria-hidden="true" tabindex="-1"></a>  multcomp<span class="sc">::</span><span class="fu">glht</span>(fit, <span class="at">linfct =</span> linfct) <span class="sc">%&gt;%</span></span>
<span id="cb133-7"><a href="15.html#cb133-7" aria-hidden="true" tabindex="-1"></a>    broom<span class="sc">::</span><span class="fu">tidy</span>(<span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb133-8"><a href="15.html#cb133-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(estimate, <span class="at">conf_low =</span> conf.low, <span class="at">conf_high =</span> conf.high)</span>
<span id="cb133-9"><a href="15.html#cb133-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Estimate ATE with 95% confidence interval for the effect of quitting smoking 5 cigarettes per day vs. not quitting.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="15.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ate</span>(fit, <span class="at">contrast =</span> <span class="fu">c</span>(<span class="at">qsmk1 =</span> <span class="dv">1</span>, <span class="st">`</span><span class="at">qsmk1:smokeintensity</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb134-2"><a href="15.html#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">nsmall =</span> <span class="dv">1</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
conf_low
</th>
<th style="text-align:right;">
conf_high
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
2.8
</td>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
4.1
</td>
</tr>
</tbody>
</table>
<p>Estimate ATE with 95% confidence interval for the effect of quitting smoking 40 cigarettes per day vs. not quitting.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="15.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ate</span>(fit, <span class="at">contrast =</span> <span class="fu">c</span>(<span class="at">qsmk1 =</span> <span class="dv">1</span>, <span class="st">`</span><span class="at">qsmk1:smokeintensity</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">40</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb135-2"><a href="15.html#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">nsmall =</span> <span class="dv">1</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
conf_low
</th>
<th style="text-align:right;">
conf_high
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
4.4
</td>
<td style="text-align:right;">
2.8
</td>
<td style="text-align:right;">
6.1
</td>
</tr>
</tbody>
</table>
<p>Fit linear regression without product terms, the same model as in 13.3.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="15.html#cb136-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> </span>
<span id="cb136-2"><a href="15.html#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(</span>
<span id="cb136-3"><a href="15.html#cb136-3" aria-hidden="true" tabindex="-1"></a>    wt82_71 <span class="sc">~</span> qsmk <span class="sc">+</span> sex <span class="sc">+</span> <span class="fu">poly</span>(age, <span class="dv">2</span>) <span class="sc">+</span> race <span class="sc">+</span> education <span class="sc">+</span> <span class="fu">poly</span>(wt71, <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb136-4"><a href="15.html#cb136-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">poly</span>(smokeintensity, <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">poly</span>(smokeyrs, <span class="dv">2</span>) <span class="sc">+</span> active <span class="sc">+</span> exercise,</span>
<span id="cb136-5"><a href="15.html#cb136-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> nhefs_censored</span>
<span id="cb136-6"><a href="15.html#cb136-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb136-7"><a href="15.html#cb136-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-8"><a href="15.html#cb136-8" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(fit)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 20 × 5
#&gt;    term          estimate std.error statistic  p.value
#&gt;    &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
#&gt;  1 (Intercept)      2.09      0.628     3.33  8.75e- 4
#&gt;  2 qsmk1            3.46      0.438     7.90  5.36e-15
#&gt;  3 sex1            -1.47      0.468    -3.13  1.79e- 3
#&gt;  4 poly(age, 2)1  -90.7      15.7      -5.77  9.51e- 9
#&gt;  5 poly(age, 2)2  -36.4      10.2      -3.56  3.89e- 4
#&gt;  6 race1            0.586     0.582     1.01  3.14e- 1
#&gt;  7 education2       0.819     0.607     1.35  1.78e- 1
#&gt;  8 education3       0.572     0.556     1.03  3.04e- 1
#&gt;  9 education4       1.51      0.832     1.81  7.01e- 2
#&gt; 10 education5      -0.171     0.741    -0.230 8.18e- 1
#&gt; # … with 10 more rows
#&gt; # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>Estimate of ATE with 95% confidence interval.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="15.html#cb138-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> </span>
<span id="cb138-2"><a href="15.html#cb138-2" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>(fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb138-3"><a href="15.html#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;qsmk1&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb138-4"><a href="15.html#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(estimate, <span class="at">conf_low =</span> conf.low, <span class="at">conf_high =</span> conf.high)</span>
<span id="cb138-5"><a href="15.html#cb138-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-6"><a href="15.html#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(v, <span class="at">nsmall =</span> <span class="dv">1</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
conf_low
</th>
<th style="text-align:right;">
conf_high
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
3.5
</td>
<td style="text-align:right;">
2.6
</td>
<td style="text-align:right;">
4.3
</td>
</tr>
</tbody>
</table>
</div>
<div id="propensity-scores" class="section level2 unnumbered hasAnchor">
<h2>15.2 Propensity scores<a href="15.html#propensity-scores" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Fit logistic regression model for propensity scores.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="15.html#cb139-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> </span>
<span id="cb139-2"><a href="15.html#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb139-3"><a href="15.html#cb139-3" aria-hidden="true" tabindex="-1"></a>    qsmk <span class="sc">~</span> sex <span class="sc">+</span> <span class="fu">poly</span>(age, <span class="dv">2</span>) <span class="sc">+</span> race <span class="sc">+</span> education <span class="sc">+</span> <span class="fu">poly</span>(wt71, <span class="dv">2</span>) <span class="sc">+</span> <span class="sc">+</span></span>
<span id="cb139-4"><a href="15.html#cb139-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">poly</span>(smokeintensity, <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">poly</span>(smokeyrs, <span class="dv">2</span>) <span class="sc">+</span> active <span class="sc">+</span> exercise,</span>
<span id="cb139-5"><a href="15.html#cb139-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb139-6"><a href="15.html#cb139-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> nhefs</span>
<span id="cb139-7"><a href="15.html#cb139-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb139-8"><a href="15.html#cb139-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-9"><a href="15.html#cb139-9" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(fit)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 19 × 5
#&gt;    term           estimate std.error statistic      p.value
#&gt;    &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;
#&gt;  1 (Intercept)     -1.04       0.194   -5.35   0.0000000897
#&gt;  2 sex1            -0.508      0.148   -3.42   0.000617    
#&gt;  3 poly(age, 2)1   23.6        4.89     4.83   0.00000134  
#&gt;  4 poly(age, 2)2   -3.76       3.15    -1.19   0.233       
#&gt;  5 race1           -0.850      0.206   -4.13   0.0000363   
#&gt;  6 education2      -0.0983     0.191   -0.516  0.606       
#&gt;  7 education3       0.0157     0.171    0.0920 0.927       
#&gt;  8 education4      -0.0425     0.264   -0.161  0.872       
#&gt;  9 education5       0.380      0.220    1.72   0.0850      
#&gt; 10 poly(wt71, 2)1   3.87       2.64     1.47   0.143       
#&gt; # … with 9 more rows
#&gt; # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>Add propensity scores to data.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="15.html#cb141-1" aria-hidden="true" tabindex="-1"></a>nhefs <span class="ot">&lt;-</span> </span>
<span id="cb141-2"><a href="15.html#cb141-2" aria-hidden="true" tabindex="-1"></a>  nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb141-3"><a href="15.html#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">propensity =</span> <span class="fu">predict</span>(fit, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span></code></pre></div>
<p>Individuals with the lowest and highest propensity scores.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="15.html#cb142-1" aria-hidden="true" tabindex="-1"></a>nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb142-2"><a href="15.html#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seqn, propensity, qsmk) <span class="sc">%&gt;%</span> </span>
<span id="cb142-3"><a href="15.html#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(propensity) <span class="sc">%&gt;%</span> </span>
<span id="cb142-4"><a href="15.html#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>, <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb142-5"><a href="15.html#cb142-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">nsmall =</span> <span class="dv">3</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
seqn
</th>
<th style="text-align:right;">
propensity
</th>
<th style="text-align:right;">
qsmk
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
22941
</td>
<td style="text-align:right;">
0.053
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
24949
</td>
<td style="text-align:right;">
0.793
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<p>Consistent with their propensity scores, individual 22941 did not quit smoking and individual 24949 did.</p>
<p>Distribution of propensity scores for non-quitters and quitters.</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="15.html#cb143-1" aria-hidden="true" tabindex="-1"></a>qsmk_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;0&quot;</span> <span class="ot">=</span> <span class="st">&quot;Non-quitters&quot;</span>, <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Quitters&quot;</span>)</span>
<span id="cb143-2"><a href="15.html#cb143-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-3"><a href="15.html#cb143-3" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> </span>
<span id="cb143-4"><a href="15.html#cb143-4" aria-hidden="true" tabindex="-1"></a>  nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb143-5"><a href="15.html#cb143-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(qsmk) <span class="sc">%&gt;%</span> </span>
<span id="cb143-6"><a href="15.html#cb143-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">propensity_mean =</span> <span class="fu">mean</span>(propensity))</span>
<span id="cb143-7"><a href="15.html#cb143-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-8"><a href="15.html#cb143-8" aria-hidden="true" tabindex="-1"></a>nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb143-9"><a href="15.html#cb143-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(propensity)) <span class="sc">+</span></span>
<span id="cb143-10"><a href="15.html#cb143-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.05</span>, <span class="at">boundary =</span> <span class="fl">0.025</span>) <span class="sc">+</span></span>
<span id="cb143-11"><a href="15.html#cb143-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> propensity_mean), <span class="at">data =</span> means, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb143-12"><a href="15.html#cb143-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_width</span>(<span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb143-13"><a href="15.html#cb143-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(qsmk), <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">qsmk =</span> qsmk_labels)) <span class="sc">+</span></span>
<span id="cb143-14"><a href="15.html#cb143-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb143-15"><a href="15.html#cb143-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Distribution of propensity scores for non-quitters and quitters&quot;</span>,</span>
<span id="cb143-16"><a href="15.html#cb143-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Red lines indicate mean propensity score for group&quot;</span>,</span>
<span id="cb143-17"><a href="15.html#cb143-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Propensity score&quot;</span>,</span>
<span id="cb143-18"><a href="15.html#cb143-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Number of subjects&quot;</span></span>
<span id="cb143-19"><a href="15.html#cb143-19" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="15_files/figure-html/unnamed-chunk-13-1.png" width="100%" /></p>
<p>Mean propensity score for group.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="15.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(means, <span class="at">nsmall =</span> <span class="dv">3</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
qsmk
</th>
<th style="text-align:right;">
propensity_mean
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.245
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.312
</td>
</tr>
</tbody>
</table>
<p>As expected, those who did not quit smoking had, on average, a lower estimated probability of quitting (0.245) than those who did quit (0.312).</p>
<p>Mean propensity scores vs. proportion for subjects who quit smoking.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="15.html#cb145-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> </span>
<span id="cb145-2"><a href="15.html#cb145-2" aria-hidden="true" tabindex="-1"></a>  nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb145-3"><a href="15.html#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">bin =</span> <span class="fu">cut_width</span>(propensity, <span class="at">width =</span> <span class="fl">0.05</span>, <span class="at">boundary =</span> <span class="fl">0.025</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb145-4"><a href="15.html#cb145-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb145-5"><a href="15.html#cb145-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">propensity_mean =</span> <span class="fu">mean</span>(propensity),</span>
<span id="cb145-6"><a href="15.html#cb145-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">qsmk_mean =</span> <span class="fu">mean</span>(<span class="fu">as.double</span>(qsmk) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb145-7"><a href="15.html#cb145-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb145-8"><a href="15.html#cb145-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb145-9"><a href="15.html#cb145-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb145-10"><a href="15.html#cb145-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-11"><a href="15.html#cb145-11" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span> </span>
<span id="cb145-12"><a href="15.html#cb145-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(propensity_mean, qsmk_mean, <span class="at">size =</span> n)) <span class="sc">+</span></span>
<span id="cb145-13"><a href="15.html#cb145-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb145-14"><a href="15.html#cb145-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb145-15"><a href="15.html#cb145-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_width</span>(<span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb145-16"><a href="15.html#cb145-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_width</span>(<span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb145-17"><a href="15.html#cb145-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb145-18"><a href="15.html#cb145-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb145-19"><a href="15.html#cb145-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> </span>
<span id="cb145-20"><a href="15.html#cb145-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Mean propensity scores vs. proportion for subjects who quit smoking&quot;</span>,</span>
<span id="cb145-21"><a href="15.html#cb145-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Mean propensity score for bin&quot;</span>,</span>
<span id="cb145-22"><a href="15.html#cb145-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Proportion of subjects in bin who quit smoking&quot;</span></span>
<span id="cb145-23"><a href="15.html#cb145-23" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="15_files/figure-html/unnamed-chunk-15-1.png" width="100%" /></p>
<p>For the bins in the histogram, this plot shows that the mean propensity score for each bin is fairly close to the actual proportion of subjects in the bin who quit smoking.</p>
</div>
<div id="propensity-stratification-and-standardization" class="section level2 unnumbered hasAnchor">
<h2>15.3 Propensity stratification and standardization<a href="15.html#propensity-stratification-and-standardization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Individual 22005 is the only person with a propensity score near 0.6563.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="15.html#cb146-1" aria-hidden="true" tabindex="-1"></a>nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb146-2"><a href="15.html#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">near</span>(propensity, <span class="fl">0.6563</span>, <span class="at">tol =</span> <span class="fl">0.0001</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb146-3"><a href="15.html#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seqn, propensity) <span class="sc">%&gt;%</span> </span>
<span id="cb146-4"><a href="15.html#cb146-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">nsmall =</span> <span class="dv">4</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
seqn
</th>
<th style="text-align:right;">
propensity
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
22005
</td>
<td style="text-align:right;">
0.6563
</td>
</tr>
</tbody>
</table>
<p>Add column for propensity score deciles.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="15.html#cb147-1" aria-hidden="true" tabindex="-1"></a>nhefs <span class="ot">&lt;-</span> </span>
<span id="cb147-2"><a href="15.html#cb147-2" aria-hidden="true" tabindex="-1"></a>  nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb147-3"><a href="15.html#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(propensity, seqn) <span class="sc">%&gt;%</span> </span>
<span id="cb147-4"><a href="15.html#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb147-5"><a href="15.html#cb147-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">decile =</span> <span class="fu">cut_number</span>(propensity, <span class="at">n =</span> <span class="dv">10</span>, <span class="at">labels =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">as.factor</span>()</span>
<span id="cb147-6"><a href="15.html#cb147-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb147-7"><a href="15.html#cb147-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(seqn)</span></code></pre></div>
<p>Number of individuals in each decile.</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="15.html#cb148-1" aria-hidden="true" tabindex="-1"></a>nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb148-2"><a href="15.html#cb148-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(decile) <span class="sc">%&gt;%</span> </span>
<span id="cb148-3"><a href="15.html#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
decile
</th>
<th style="text-align:right;">
n
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
163
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
163
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
163
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
163
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
163
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
162
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
163
</td>
</tr>
<tr>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
163
</td>
</tr>
<tr>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
163
</td>
</tr>
<tr>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
163
</td>
</tr>
</tbody>
</table>
<p>Fit linear regression with decile interaction.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="15.html#cb149-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk <span class="sc">*</span> decile, <span class="at">data =</span> nhefs)</span>
<span id="cb149-2"><a href="15.html#cb149-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-3"><a href="15.html#cb149-3" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(fit)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 20 × 5
#&gt;    term        estimate std.error statistic  p.value
#&gt;    &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
#&gt;  1 (Intercept)   4.00       0.630   6.34    3.04e-10
#&gt;  2 qsmk1        -0.0147     2.39   -0.00613 9.95e- 1
#&gt;  3 decile2      -1.09       0.916  -1.19    2.34e- 1
#&gt;  4 decile3      -1.38       0.918  -1.51    1.32e- 1
#&gt;  5 decile4      -0.521      0.926  -0.562   5.74e- 1
#&gt;  6 decile5      -1.90       0.940  -2.02    4.39e- 2
#&gt;  7 decile6      -2.15       0.954  -2.25    2.44e- 2
#&gt;  8 decile7      -2.44       0.949  -2.57    1.04e- 2
#&gt;  9 decile8      -3.71       0.974  -3.81    1.44e- 4
#&gt; 10 decile9      -4.89       1.03   -4.73    2.44e- 6
#&gt; # … with 10 more rows
#&gt; # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>Estimate ATE with 95% confidence interval for decile.</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="15.html#cb151-1" aria-hidden="true" tabindex="-1"></a>ate <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, decile) {</span>
<span id="cb151-2"><a href="15.html#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (decile <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb151-3"><a href="15.html#cb151-3" aria-hidden="true" tabindex="-1"></a>    contrast <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">qsmk1 =</span> <span class="dv">1</span>)</span>
<span id="cb151-4"><a href="15.html#cb151-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb151-5"><a href="15.html#cb151-5" aria-hidden="true" tabindex="-1"></a>    contrast <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb151-6"><a href="15.html#cb151-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(contrast) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;qsmk1&quot;</span>, <span class="fu">str_c</span>(<span class="st">&quot;qsmk1:decile&quot;</span>, decile))</span>
<span id="cb151-7"><a href="15.html#cb151-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-8"><a href="15.html#cb151-8" aria-hidden="true" tabindex="-1"></a>  linfct <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> <span class="fu">length</span>(<span class="fu">coef</span>(fit)))</span>
<span id="cb151-9"><a href="15.html#cb151-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(linfct) <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">coef</span>(fit))</span>
<span id="cb151-10"><a href="15.html#cb151-10" aria-hidden="true" tabindex="-1"></a>  linfct[, <span class="fu">names</span>(contrast)] <span class="ot">&lt;-</span> contrast</span>
<span id="cb151-11"><a href="15.html#cb151-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-12"><a href="15.html#cb151-12" aria-hidden="true" tabindex="-1"></a>  multcomp<span class="sc">::</span><span class="fu">glht</span>(fit, <span class="at">linfct =</span> linfct) <span class="sc">%&gt;%</span></span>
<span id="cb151-13"><a href="15.html#cb151-13" aria-hidden="true" tabindex="-1"></a>    broom<span class="sc">::</span><span class="fu">tidy</span>(<span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb151-14"><a href="15.html#cb151-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(estimate, <span class="at">conf_low =</span> conf.low, <span class="at">conf_high =</span> conf.high) <span class="sc">%&gt;%</span> </span>
<span id="cb151-15"><a href="15.html#cb151-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_column</span>(decile, <span class="at">.before =</span> <span class="st">&quot;estimate&quot;</span>)</span>
<span id="cb151-16"><a href="15.html#cb151-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Estimates of ATE with 95% confidence intervals for all deciles.</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="15.html#cb152-1" aria-hidden="true" tabindex="-1"></a>ate_decile <span class="ot">&lt;-</span> </span>
<span id="cb152-2"><a href="15.html#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span> <span class="sc">%&gt;%</span> </span>
<span id="cb152-3"><a href="15.html#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(<span class="sc">~</span> <span class="fu">ate</span>(fit, <span class="at">decile =</span> .)) <span class="sc">%&gt;%</span> </span>
<span id="cb152-4"><a href="15.html#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(decile, as.factor))</span>
<span id="cb152-5"><a href="15.html#cb152-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-6"><a href="15.html#cb152-6" aria-hidden="true" tabindex="-1"></a>ate_decile <span class="sc">%&gt;%</span> </span>
<span id="cb152-7"><a href="15.html#cb152-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">nsmall =</span> <span class="dv">1</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
decile
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
conf_low
</th>
<th style="text-align:right;">
conf_high
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
-4.7
</td>
<td style="text-align:right;">
4.7
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
4.1
</td>
<td style="text-align:right;">
0.9
</td>
<td style="text-align:right;">
7.4
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
6.5
</td>
<td style="text-align:right;">
3.4
</td>
<td style="text-align:right;">
9.7
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2.3
</td>
<td style="text-align:right;">
-0.6
</td>
<td style="text-align:right;">
5.2
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
4.1
</td>
<td style="text-align:right;">
1.4
</td>
<td style="text-align:right;">
6.8
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
4.5
</td>
<td style="text-align:right;">
1.8
</td>
<td style="text-align:right;">
7.2
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
4.3
</td>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
7.1
</td>
</tr>
<tr>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
3.6
</td>
<td style="text-align:right;">
0.9
</td>
<td style="text-align:right;">
6.2
</td>
</tr>
<tr>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
2.3
</td>
<td style="text-align:right;">
-0.2
</td>
<td style="text-align:right;">
4.8
</td>
</tr>
<tr>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
2.2
</td>
<td style="text-align:right;">
-0.2
</td>
<td style="text-align:right;">
4.7
</td>
</tr>
</tbody>
</table>
<p>Estimated average treatment effect for each propensity score decile.</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="15.html#cb153-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> </span>
<span id="cb153-2"><a href="15.html#cb153-2" aria-hidden="true" tabindex="-1"></a>  nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb153-3"><a href="15.html#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(decile) <span class="sc">%&gt;%</span> </span>
<span id="cb153-4"><a href="15.html#cb153-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">propensity_mean =</span> <span class="fu">mean</span>(propensity)) <span class="sc">%&gt;%</span> </span>
<span id="cb153-5"><a href="15.html#cb153-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ate_decile, <span class="at">by =</span> <span class="st">&quot;decile&quot;</span>)</span>
<span id="cb153-6"><a href="15.html#cb153-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-7"><a href="15.html#cb153-7" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span> </span>
<span id="cb153-8"><a href="15.html#cb153-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(propensity_mean, estimate)) <span class="sc">+</span></span>
<span id="cb153-9"><a href="15.html#cb153-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf_low, <span class="at">ymax =</span> conf_high)) <span class="sc">+</span></span>
<span id="cb153-10"><a href="15.html#cb153-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb153-11"><a href="15.html#cb153-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> </span>
<span id="cb153-12"><a href="15.html#cb153-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Estimated average treatment effect for each propensity score decile&quot;</span>,</span>
<span id="cb153-13"><a href="15.html#cb153-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Range indicates 95% confidence interval&quot;</span>,</span>
<span id="cb153-14"><a href="15.html#cb153-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Mean propensity score for decile&quot;</span>,</span>
<span id="cb153-15"><a href="15.html#cb153-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Estimated average treatment effect for decile (kg)&quot;</span></span>
<span id="cb153-16"><a href="15.html#cb153-16" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="15_files/figure-html/unnamed-chunk-22-1.png" width="100%" /></p>
<p>Fit linear regression without decile interaction.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="15.html#cb154-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk <span class="sc">+</span> decile, <span class="at">data =</span> nhefs)</span>
<span id="cb154-2"><a href="15.html#cb154-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-3"><a href="15.html#cb154-3" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(fit)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 11 × 5
#&gt;    term        estimate std.error statistic  p.value
#&gt;    &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
#&gt;  1 (Intercept)    3.75      0.609     6.16  9.29e-10
#&gt;  2 qsmk1          3.50      0.457     7.66  3.28e-14
#&gt;  3 decile2       -0.739     0.861    -0.858 3.91e- 1
#&gt;  4 decile3       -0.618     0.861    -0.718 4.73e- 1
#&gt;  5 decile4       -0.520     0.858    -0.606 5.44e- 1
#&gt;  6 decile5       -1.49      0.859    -1.73  8.34e- 2
#&gt;  7 decile6       -1.62      0.868    -1.87  6.16e- 2
#&gt;  8 decile7       -1.99      0.868    -2.29  2.23e- 2
#&gt;  9 decile8       -3.44      0.875    -3.94  8.61e- 5
#&gt; 10 decile9       -5.15      0.885    -5.83  6.91e- 9
#&gt; # … with 1 more row
#&gt; # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>Propensity score stratification - Decile: estimate of ATE with 95% confidence interval.</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="15.html#cb156-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span></span>
<span id="cb156-2"><a href="15.html#cb156-2" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>(fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb156-3"><a href="15.html#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;qsmk1&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb156-4"><a href="15.html#cb156-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(estimate, <span class="at">conf_low =</span> conf.low, <span class="at">conf_high =</span> conf.high)</span>
<span id="cb156-5"><a href="15.html#cb156-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-6"><a href="15.html#cb156-6" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(v, <span class="at">nsmall =</span> <span class="dv">1</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
conf_low
</th>
<th style="text-align:right;">
conf_high
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
3.5
</td>
<td style="text-align:right;">
2.6
</td>
<td style="text-align:right;">
4.4
</td>
</tr>
</tbody>
</table>
<p>Fit linear regression with continuous propensity score.</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="15.html#cb157-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk <span class="sc">+</span> propensity, <span class="at">data =</span> nhefs)</span>
<span id="cb157-2"><a href="15.html#cb157-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-3"><a href="15.html#cb157-3" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(fit)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 3 × 5
#&gt;   term        estimate std.error statistic  p.value
#&gt;   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
#&gt; 1 (Intercept)     5.59     0.483     11.6  8.16e-30
#&gt; 2 qsmk1           3.55     0.457      7.76 1.47e-14
#&gt; 3 propensity    -14.8      1.76      -8.43 7.55e-17</code></pre>
<p>Propensity score stratification - Continuous: estimate of ATE with 95% confidence interval.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="15.html#cb159-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span></span>
<span id="cb159-2"><a href="15.html#cb159-2" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>(fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb159-3"><a href="15.html#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;qsmk1&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb159-4"><a href="15.html#cb159-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(estimate, <span class="at">conf_low =</span> conf.low, <span class="at">conf_high =</span> conf.high)</span>
<span id="cb159-5"><a href="15.html#cb159-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-6"><a href="15.html#cb159-6" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(v, <span class="at">nsmall =</span> <span class="dv">1</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
conf_low
</th>
<th style="text-align:right;">
conf_high
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
3.6
</td>
<td style="text-align:right;">
2.7
</td>
<td style="text-align:right;">
4.4
</td>
</tr>
</tbody>
</table>
<p>Data with values for <code>wt82_71</code>.</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="15.html#cb160-1" aria-hidden="true" tabindex="-1"></a>nhefs_censored <span class="ot">&lt;-</span> </span>
<span id="cb160-2"><a href="15.html#cb160-2" aria-hidden="true" tabindex="-1"></a>  nhefs <span class="sc">%&gt;%</span> </span>
<span id="cb160-3"><a href="15.html#cb160-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(wt82_71)</span></code></pre></div>
<p>ATE using fit on sample of data.</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="15.html#cb161-1" aria-hidden="true" tabindex="-1"></a>ate <span class="ot">&lt;-</span> <span class="cf">function</span>(data, sample_rows) {</span>
<span id="cb161-2"><a href="15.html#cb161-2" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(wt82_71 <span class="sc">~</span> qsmk <span class="sc">+</span> propensity, <span class="at">data =</span> data <span class="sc">%&gt;%</span> <span class="fu">slice</span>(sample_rows))</span>
<span id="cb161-3"><a href="15.html#cb161-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb161-4"><a href="15.html#cb161-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">predict</span>(fit, <span class="at">newdata =</span> nhefs <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">qsmk =</span> <span class="st">&quot;1&quot;</span>))) <span class="sc">-</span></span>
<span id="cb161-5"><a href="15.html#cb161-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">predict</span>(fit, <span class="at">newdata =</span> nhefs <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">qsmk =</span> <span class="st">&quot;0&quot;</span>)))</span>
<span id="cb161-6"><a href="15.html#cb161-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Estimate of ATE.</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="15.html#cb162-1" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">ate</span>(<span class="at">data =</span> nhefs_censored, <span class="at">sample_rows =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(nhefs_censored))</span>
<span id="cb162-2"><a href="15.html#cb162-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-3"><a href="15.html#cb162-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb162-4"><a href="15.html#cb162-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">nsmall =</span> <span class="dv">1</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
3.6
</td>
</tr>
</tbody>
</table>
<p>We will now use bootstrapping to obtain a confidence interval for this estimate.</p>
<p>Perform bootstrap resampling.</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="15.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">231</span>)</span>
<span id="cb163-2"><a href="15.html#cb163-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-3"><a href="15.html#cb163-3" aria-hidden="true" tabindex="-1"></a>n_boot <span class="ot">&lt;-</span> <span class="fl">1e4</span></span>
<span id="cb163-4"><a href="15.html#cb163-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-5"><a href="15.html#cb163-5" aria-hidden="true" tabindex="-1"></a>boot_out <span class="ot">&lt;-</span> boot<span class="sc">::</span><span class="fu">boot</span>(<span class="at">data =</span> nhefs_censored, <span class="at">statistic =</span> ate, <span class="at">R =</span> n_boot)</span></code></pre></div>
<p>Distribution of average treatment effect.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="15.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">ate =</span> boot_out<span class="sc">$</span>t) <span class="sc">%&gt;%</span> </span>
<span id="cb164-2"><a href="15.html#cb164-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(ate)) <span class="sc">+</span></span>
<span id="cb164-3"><a href="15.html#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.1</span>, <span class="at">boundary =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb164-4"><a href="15.html#cb164-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb164-5"><a href="15.html#cb164-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Distribution of average treatment effect&quot;</span>,</span>
<span id="cb164-6"><a href="15.html#cb164-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Average treatment effect&quot;</span>,</span>
<span id="cb164-7"><a href="15.html#cb164-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Count&quot;</span></span>
<span id="cb164-8"><a href="15.html#cb164-8" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="15_files/figure-html/unnamed-chunk-33-1.png" width="100%" /></p>
<p>Propensity score standardization: estimate of ATE with 95% confidence interval. Confidence interval calculated using bias-corrected and accelerated (BCa) method.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="15.html#cb165-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> </span>
<span id="cb165-2"><a href="15.html#cb165-2" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>(boot_out, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">conf.method =</span> <span class="st">&quot;bca&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb165-3"><a href="15.html#cb165-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(estimate, <span class="at">conf_low =</span> conf.low, <span class="at">conf_high =</span> conf.high)</span>
<span id="cb165-4"><a href="15.html#cb165-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-5"><a href="15.html#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(v, <span class="at">nsmall =</span> <span class="dv">1</span>)</span></code></pre></div>
<table class="table" style="width: auto !important; ">
<thead>
<tr>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
conf_low
</th>
<th style="text-align:right;">
conf_high
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
3.6
</td>
<td style="text-align:right;">
2.6
</td>
<td style="text-align:right;">
4.5
</td>
</tr>
</tbody>
</table>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="14.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="16.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/behrman/ci-wi/edit/master/15.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
